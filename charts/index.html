<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <!--<script src="javascripts/libs/react-0.13.3/build/react.min.js"></script>-->
    <!--<script src="javascripts/libs/react-0.13.3/build/JSXTransformer.js"></script>-->
    <!--<script data-main="javascripts/main.js" src="javascripts/libs/require-2.1.20.js"></script>-->

    <script type="application/javascript">
        window.onload = function(){


            function Field(canvas) {
                this.zoom = 16;
                this.centerShiftX = -585;
                this.centerShiftY = 0;

//                var stepAxisColor = "#51C2FC";
//                var bgColor = "#3DB2FF";
//                var axisColor = "#84DAFE";


                this.width = canvas.offsetWidth;
                this.height = canvas.offsetHeight;

                this.ctx = canvas.getContext('2d'); //todo: check for support

                this.functions = [];

                // Zooming
                canvas.addEventListener('mousewheel', function(e){
                    if(e.wheelDelta>0) {
                        this.zoom *= 1.25;
                    }
                    else if(this.zoom > 5) {
                        this.zoom /= 1.25;
                    }
                    this.redraw();
                }.bind(this));

                // Drag and drop
                var draging = false;
                var startX = 0;
                var startY = 0;
                canvas.addEventListener('mousedown', function(e){
                    startX = (e.pageX - canvas.offsetTop);
                    startY = (e.pageY - canvas.offsetLeft);
                    draging = true;
                });
                canvas.addEventListener('mouseup', function(e){
                    if(draging) {
                        draging = false;
                    }
                }.bind(this));
                canvas.addEventListener('mousemove', function(e){
                    if(draging) {
                        var newX = (e.pageX - canvas.offsetTop);
                        var newY = (e.pageY - canvas.offsetLeft);
                        this.centerShiftX += newX - startX;
                        this.centerShiftY += newY - startY;
                        startX = newX;
                        startY = newY;
                        this.redraw();
                    }
                }.bind(this));
                window.addEventListener('mousemove', function(e){
                    if(e.target != canvas && draging) {
                        draging = false;
                    }
                });

                var disableHandler = function (e) {
                    if (e.preventDefault()) {
                        e.preventDefault();
                    }
                    e.returnValue = false;
                };

                //Disable and enable scrolling when working with canvas
                canvas.addEventListener('mouseenter', function(){
                    if (window.addEventListener) {
                        window.addEventListener('DOMMouseScroll', disableHandler, false);
                    }
                    window.onmousewheel = document.onmousewheel = disableHandler
                });
                canvas.addEventListener('mouseleave', function(){
                    window.onmousewheel = document.onmousewheel = null
                });

                this.redraw();

            }

            Field.prototype.redraw = function(){
                var stepAxisColor = "#EEEEEE";
                var bgColor = "#FFFFFF";
                var axisColor = "#000000";

                this.stepX = this.zoom;
                this.stepY = this.zoom;

                this.centerX = this.width/2 + this.centerShiftX;
                this.centerY = this.height/2 + this.centerShiftY;

                this.ctx.lineWidth = 1;

                this.ctx.fillStyle = bgColor;
                this.ctx.fillRect(0, 0, this.width, this.height);


                // Draw steps
                this.ctx.strokeStyle = stepAxisColor;
                for(var i = this.centerX+this.stepX; i<this.width; i+=this.stepX) {
                    var line = new Path2D();
                    line.moveTo(i, 0);
                    line.lineTo(i, this.height);
                    this.ctx.stroke(line);
                }
                for(var i = this.centerX-this.stepX; i>0; i-=this.stepX) {
                    var line = new Path2D();
                    line.moveTo(i, 0);
                    line.lineTo(i, this.height);
                    this.ctx.stroke(line);
                }

                for(var i = this.centerY+this.stepY; i<this.height; i+=this.stepY) {
                    var line = new Path2D();
                    line.moveTo(0, i);
                    line.lineTo(this.width, i);
                    this.ctx.stroke(line);
                }
                for(var i = this.centerY-this.stepY; i>0; i-=this.stepY) {
                    var line = new Path2D();
                    line.moveTo(0, i);
                    line.lineTo(this.width, i);
                    this.ctx.stroke(line);
                }


                // Draw labels
                this.ctx.font = "8px sans-serif";
                this.ctx.fillStyle = "#BBB";
                var step, i = 0;
                for(i = this.centerX+this.stepX, step = 0; i<this.width; i+=this.stepX) {
                    this.ctx.fillText(step, i, this.centerY + 8);
                    step++;
                }
                for(i = this.centerX-this.stepX, step = 0; i>0; i-=this.stepX) {
                    this.ctx.fillText("-" + step, i, this.centerY + 8);
                    step++;
                }

                for(i = this.centerY+this.stepY, step = 0; i<this.height; i+=this.stepY) {
                    this.ctx.fillText("-" + step, this.centerX - 10, i);
                    step++;
                }
                for(i = this.centerY-this.stepY, step = 0; i>0; i-=this.stepY) {
                    this.ctx.fillText(step, this.centerX - 10, i);
                    step++;
                }



                this.ctx.strokeStyle = axisColor;

                var xAxis = new Path2D();
                xAxis.moveTo(0, this.centerY);
                xAxis.lineTo(this.width, this.centerY);
                this.ctx.stroke(xAxis);

                var yAxis = new Path2D();
                yAxis.moveTo(this.centerX, 0);
                yAxis.lineTo(this.centerX, this.height);
                this.ctx.stroke(yAxis);

                // Redraw functions
                this.redrawFunctions();

            };

            Field.prototype.redrawFunctions = function() {
                for (var i = 0; i < this.functions.length; i++) {
                    var f = this.functions[i];
                    var xvArea = this.visibleXVArea();

                    var last = null;
                    var dif = 5 / this.stepX;
                    for(var x = xvArea.minX; x<= xvArea.maxX ; x += dif) {
                        var next = [x, f(x)];
                        if(last) {
                            this.drawLine(last, next);
                        }
                        last = next;
                    }
                }
            };

            Field.prototype.visibleXVArea = function(){
                return {
                    minX:this.centerX / this.stepX * -1,
                    maxX:(this.width - this.centerX) / this.stepX
                }
            };

            Field.prototype.drawLine = function(fromV, toV){
                var fromX = this.centerX + (this.stepX * fromV[0]);
                var fromY = this.centerY - (this.stepY * fromV[1]);
                var toX = this.centerX + (this.stepX * toV[0]);
                var toY = this.centerY - (this.stepY * toV[1]);

                var line = new Path2D();
                line.moveTo(fromX, fromY);
                line.lineTo(toX, toY);

                this.ctx.strokeStyle = "#000";
                this.ctx.stroke(line);

            };


            Field.prototype.realXY = function(vXY) {
                return [
                    this.centerX + (this.stepX * vXY[0]),
                    this.centerY - (this.stepY * vXY[1])
                ]
            };



            Field.prototype.drawF = function(f) {
                this.functions.push(f);
                this.redrawFunctions()
            };


            Array.prototype.foldl = function(acc, f) {
                for (var i = 0; i < this.length; i++) {
                    acc = f(acc, this[i])
                }
                return acc;
            };




            var field = new Field(document.getElementById("canvas"));


            var samples = [];
            for(var i = 0; i<1000; i++) {
                if(i>500) {
                    samples.push(9 + 2 * Math.random())
                }
                else {
                    samples.push(3 + 2 * Math.random())
                }
            }
//            var samples = [8,9,8,10,14,11,9,10,11,9,8,8];

            var h = 5;

            function ind(x) {
                return Math.abs(x) <= 1 ? 1 : 0
            }

            function uniformKernel(x) {
                return 1/2 * ind(x)
            }

            function triangularKernel(x) {
                return (1 - Math.abs(x)) * ind(x);
            }

            function epanechnikovKernel(x) {
                return 3/4 * (1 - x * x) * ind(x);
            }

            field.drawF(function(x){ return  x * x});
            field.drawF(function(x){
                var n = samples.length;
                var sum = samples.foldl(0, function(sum, xi){
                    return sum + epanechnikovKernel ((x - xi)/h)
                });
                var result = sum / (n * h);
                return result
            })



        }
    </script>

</head>
<body >
    <div id="example"></div>
    <canvas width="1500" height="500" style="margin: 40px; border: 1px solid black;" id="canvas"></canvas>
</body>
</html>